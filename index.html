<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BooksByNIK | Login</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
</head>

<body class="bg-gray-50 text-gray-900 flex items-center justify-center min-h-screen transition-colors duration-300">
    <div class="w-full max-w-md p-6 bg-white shadow-xl rounded-lg border border-gray-200 dark:bg-gray-800 dark:text-gray-100 dark:border-gray-700">
        <h1 class="text-3xl font-bold text-center mb-6">Welcome to BooksByNIK</h1>
        <p id="authMessage" class="text-center text-sm mb-6 text-gray-500 dark:text-gray-400">Enter your details to access the catalog.</p>

        <form id="loginForm" class="space-y-4">
            <div>
                <label for="userName" class="block text-sm font-medium mb-1">Your Name</label>
                <input type="text" id="userName" required class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" placeholder="e.g., NIK Name">
            </div>
            <div>
                <label for="userNumber" class="block text-sm font-medium mb-1">Phone Number (10 digits)</label>
                <input type="tel" id="userNumber" required pattern="[0-9]{10}" maxlength="10" class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100" placeholder="e.g., 9876543210">
            </div>

            <div class="flex justify-between items-center pt-2">
                <label class="block text-sm font-medium">App Language:</label>
                <select id="languageSelect" class="p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
                    <option value="en">English</option>
                    <option value="ml">മലയാളം (Malayalam)</option>
                </select>
            </div>

            <button type="submit" id="loginButton" class="w-full bg-blue-600 text-white p-3 rounded-md font-semibold hover:bg-blue-700 transition duration-200">
                Login / Register
            </button>
            
            <p id="statusMessage" class="text-center text-sm mt-3 text-red-500 hidden"></p>
        </form>
    </div>

    <script type="module">
        import { API_ENDPOINTS, setLanguage, applyTheme } from './script.js';

        // NOTE: The API_ENDPOINTS is imported from script.js

        document.addEventListener('DOMContentLoaded', () => {
            applyTheme(); // Apply theme before showing page

            const loginForm = document.getElementById('loginForm');
            const userNameInput = document.getElementById('userName');
            const userNumberInput = document.getElementById('userNumber');
            const languageSelect = document.getElementById('languageSelect');
            const statusMessage = document.getElementById('statusMessage');

            // Set language selection based on stored preference
            languageSelect.value = localStorage.getItem('appLanguage') || 'en';

            languageSelect.addEventListener('change', (e) => {
                setLanguage(e.target.value);
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                statusMessage.classList.add('hidden');
                
                const name = userNameInput.value.trim();
                const number = userNumberInput.value.trim();
                const language = languageSelect.value;
                
                if (!name || !number || number.length !== 10) {
                    statusMessage.textContent = "Please enter a valid name and 10-digit number.";
                    statusMessage.classList.remove('hidden');
                    return;
                }

                // Show loading state
                document.getElementById('loginButton').textContent = 'Processing...';
                document.getElementById('loginButton').disabled = true;

                try {
                    const response = await fetch(API_ENDPOINTS.PROFILE_API_ENDPOINT, {
                        method: 'POST',
                        mode: 'no-cors', // Important for Apps Script POST when using client-side JS
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `action=saveProfile&name=${encodeURIComponent(name)}&number=${encodeURIComponent(number)}&language=${language}`
                    });
                    
                    // Since mode: 'no-cors' is used, we cannot read the response status/body,
                    // so we proceed based on the assumption that the request was sent.
                    
                    // Save to local storage for quick access and authentication guard
                    localStorage.setItem('userName', name);
                    localStorage.setItem('userNumber', number);
                    localStorage.setItem('appLanguage', language);
                    
                    // Redirect to the home page (catalog)
                    window.location.replace('home.html');

                } catch (error) {
                    console.error('API submission failed:', error);
                    statusMessage.textContent = "Network error. Please try again later.";
                    statusMessage.classList.remove('hidden');

                    // Restore button state on failure
                    document.getElementById('loginButton').textContent = 'Login / Register';
                    document.getElementById('loginButton').disabled = false;
                }
            });
        });
    </script>
    <script type="module" src="script.js"></script>
</body>
</html>