<script type="module">
        // IMPORT FIX: Ensure initializeTheme and toggleTheme are imported for the login page
        import { API_ENDPOINTS, toggleTheme, initializeTheme } from './script.js'; 
        import { setLanguage, applyTranslations, translations, getAppLanguage } from './i18n.js';
        
        const loginForm = document.getElementById('loginForm');
        const userNumberInput = document.getElementById('userNumber');
        const userNameInput = document.getElementById('userName');
        const appLanguageSelect = document.getElementById('appLanguage');
        const loginButton = document.getElementById('loginButton');

        async function saveProfileData(name, number, lang) {
            loginButton.textContent = 'Saving Profile...';
            loginButton.disabled = true;

            try {
                const formData = new URLSearchParams();
                formData.append('action', 'saveProfile'); 
                formData.append('userName', name);
                formData.append('userNumber', number);
                formData.append('appLanguage', lang);

                // API call to Google Sheet
                await fetch(API_ENDPOINTS.PROFILE_API_ENDPOINT, {
                    method: 'POST',
                    mode: 'no-cors', // Essential for Google Apps Script interaction
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData.toString()
                });

                // Save data locally and redirect
                localStorage.setItem('userName', name);
                localStorage.setItem('userNumber', number);
                localStorage.setItem('appLanguage', lang);

                window.location.replace('home.html');

            } catch (error) {
                console.error('API Error: Could not save profile to Google Sheet.', error);
                
                // Fallback: Save local data even if API fails and proceed
                localStorage.setItem('userName', name);
                localStorage.setItem('userNumber', number);
                localStorage.setItem('appLanguage', lang);
                
                alert("Profile saved locally, but error contacting server. Please check your API URL.");
                window.location.replace('home.html');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // THEME FIX: Initialize theme and set language on load
            initializeTheme();
            const currentLang = getAppLanguage();
            appLanguageSelect.value = currentLang;
        });
        
        // THEME FIX: Re-bind the theme toggle listener
        document.getElementById('themeToggle').addEventListener('click', toggleTheme);

        appLanguageSelect.addEventListener('change', (e) => {
            setLanguage(e.target.value);
            applyTranslations(); 
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const name = userNameInput.value.trim();
            const number = userNumberInput.value.trim();
            const lang = appLanguageSelect.value;
            const t = translations[getAppLanguage()] || translations['en'];

            if (!name) {
                alert(t['nameRequired']);
                return;
            }
            if (!number || number.length !== 10) {
                alert(t['numberRequired']);
                return;
            }

            saveProfileData(name, number, lang);
        });
    </script>