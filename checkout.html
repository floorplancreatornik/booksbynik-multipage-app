<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="checkout">Checkout - BooksByNIK</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-50 dark:bg-gray-800 transition-colors duration-300">
    <div class="max-w-md mx-auto p-4 pt-8 mb-20">

        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold dark:text-white" data-i18n="checkout">Checkout</h1>
            <button id="themeToggle" class="text-gray-800 dark:text-gray-200 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                <svg id="sunIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="moonIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>

        <form id="orderForm" class="bg-white dark:bg-gray-700 shadow-md rounded-lg p-6 space-y-4">
            
            <h2 class="text-xl font-semibold dark:text-white" data-i18n="orderSummary">Order Details</h2>
            
            <div class="border p-3 rounded-md dark:border-gray-600">
                <h3 class="font-semibold text-lg mb-2 dark:text-white">Items:</h3>
                <div id="orderItemsList" class="text-sm dark:text-gray-300">
                    </div>
            </div>

            <div class="flex justify-between text-xl font-bold dark:text-white border-t border-gray-200 dark:border-gray-600 pt-4">
                <span data-i18n="total">Total:</span>
                <span id="finalTotalAmount">â‚¹0.00</span>
            </div>

            <p class="text-xs text-gray-500 dark:text-gray-400" data-i18n="shippingNote">*Taxes and shipping are included in the total for simplicity.</p>

            <h2 class="text-xl font-semibold pt-4 dark:text-white" data-i18n="shippingDetails">Shipping Details</h2>

            <div>
                <label for="orderName" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="yourName">Your Name</label>
                <input type="text" id="orderName" name="orderName" required
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 dark:bg-gray-800 dark:text-white">
            </div>
            
            <div>
                <label for="orderNumber" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="phoneNumber">Phone Number (10 digits)</label>
                <input type="tel" id="orderNumber" name="orderNumber" required pattern="\d{10}" maxlength="10"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 dark:bg-gray-800 dark:text-white">
            </div>

            <div>
                <label for="orderAddress" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="fullAddress">Full Address (with Pincode)</label>
                <textarea id="orderAddress" name="orderAddress" rows="3" required
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 dark:bg-gray-800 dark:text-white"></textarea>
            </div>
            
            <button id="payButton" type="submit" class="w-full bg-green-600 text-white py-3 rounded-md hover:bg-green-700 transition duration-150" data-i18n="payNow">
                Pay Now via UPI
            </button>
            <p id="submissionStatus" class="text-center mt-2 hidden text-sm"></p>
        </form>

    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-700 shadow-lg border-t border-gray-200 dark:border-gray-600 z-10">
        <div class="flex justify-around">
            <a href="home.html" class="flex flex-col items-center p-3 text-gray-500 dark:text-gray-400 hover:text-green-600 dark:hover:text-green-400">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                <span class="text-xs">Home</span>
            </a>
            <a href="cart.html" class="flex flex-col items-center p-3 text-gray-500 dark:text-gray-400 hover:text-green-600 dark:hover:text-green-400">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                <span class="text-xs">Cart</span>
            </a>
            <a href="profile.html" class="flex flex-col items-center p-3 text-gray-500 dark:text-gray-400 hover:text-green-600 dark:hover:text-green-400">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                <span class="text-xs">Profile</span>
            </a>
        </div>
    </nav>
    
    <script type="module">
        // --- ðŸ”‘ I18N FIX: Import language from i18n.js ---
        import { API_ENDPOINTS } from './script.js'; 
        import { translations, getAppLanguage } from './i18n.js';

        const orderForm = document.getElementById('orderForm');
        const orderItemsList = document.getElementById('orderItemsList');
        const finalTotalAmount = document.getElementById('finalTotalAmount');
        const submissionStatus = document.getElementById('submissionStatus');
        const payButton = document.getElementById('payButton');

        // Function to load and display cart items
        function loadOrderDetails() {
            const userName = localStorage.getItem('userName');
            const userNumber = localStorage.getItem('userNumber');
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            let total = 0;

            // Pre-fill user data
            document.getElementById('orderName').value = userName || '';
            document.getElementById('orderNumber').value = userNumber || '';

            // Display cart items
            orderItemsList.innerHTML = '';
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                orderItemsList.innerHTML += `<p class="flex justify-between">${item.title} (x${item.quantity}) <span>â‚¹${itemTotal.toFixed(2)}</span></p>`;
            });

            finalTotalAmount.textContent = `â‚¹${total.toFixed(2)}`;

            if (cart.length === 0) {
                orderForm.innerHTML = '<p class="text-center text-red-500 dark:text-red-400" data-i18n="cartEmpty">Your cart is empty. Go back to Home.</p>';
            }
        }

        // Function to submit order to Google Sheet and trigger UPI payment
        orderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const t = translations[getAppLanguage()] || translations['en'];
            
            // Collect data
            const orderData = {
                orderId: Date.now().toString(36).toUpperCase(), // Simple unique ID
                name: document.getElementById('orderName').value,
                number: document.getElementById('orderNumber').value,
                address: document.getElementById('orderAddress').value,
                items: JSON.parse(localStorage.getItem('cart')) || [],
                total: parseFloat(finalTotalAmount.textContent.replace('â‚¹', '')),
                timestamp: new Date().toISOString()
            };

            if (orderData.items.length === 0) return; // Should be handled by loadOrderDetails

            payButton.textContent = 'Processing...';
            payButton.disabled = true;
            submissionStatus.classList.remove('hidden');
            submissionStatus.textContent = 'Submitting order details...';

            try {
                // 1. Submit Order to Google Sheet (API)
                const formData = new URLSearchParams();
                formData.append('action', 'placeOrder'); // Action for your Apps Script
                formData.append('orderId', orderData.orderId);
                formData.append('name', orderData.name);
                formData.append('number', orderData.number);
                formData.append('address', orderData.address);
                formData.append('total', orderData.total);
                formData.append('items', JSON.stringify(orderData.items));
                
                // IMPORTANT: Use no-cors for Apps Script API submission
                await fetch(API_ENDPOINTS.ORDER_API_ENDPOINT, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData.toString()
                });
                
                submissionStatus.textContent = 'Order logged. Redirecting to UPI...';

                // 2. Trigger UPI Payment Link (The core UPI logic)
                const upiId = "YOUR_UPI_ID_HERE@oksbi"; // REPLACE THIS WITH YOUR REAL UPI ID
                const merchantName = "BooksByNIK"; 
                
                // Create the custom UPI note using Order ID
                const upiNote = `Order ID: ${orderData.orderId}`;

                const upiUrl = `upi://pay?pa=${upiId}&pn=${merchantName}&mc=0000&tid=${orderData.orderId}&tr=${orderData.orderId}&am=${orderData.total.toFixed(2)}&cu=INR&tn=${encodeURIComponent(upiNote)}`;
                
                // Clear cart locally before redirecting
                localStorage.removeItem('cart');

                // Redirect user to UPI app/page
                window.location.href = upiUrl; 
                
            } catch (error) {
                console.error('Submission Error:', error);
                submissionStatus.textContent = 'An error occurred. Please try again or contact support.';
                payButton.textContent = 'Try Again';
                payButton.disabled = false;
            }
        });

        document.addEventListener('DOMContentLoaded', loadOrderDetails);
    </script>
</body>
</html>