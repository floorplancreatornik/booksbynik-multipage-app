<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BooksByNIK - Checkout</title>
    <link rel="stylesheet" href="styles.css"> 
</head>
<body>

    <header>
        <div class="logo">BooksByNIK</div>
        <nav>
            <a href="home.html" data-i18n="catalog">Catalog</a>
            <a href="cart.html" data-i18n="cart">Cart</a>
            <a href="profile.html" data-i18n="profile">Profile</a>
        </nav>
        <div class="header-controls">
            <select id="lang-selector" class="uniform-input">
                <option value="en">English</option>
                <option value="ml">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç</option>
            </select>
            
            <button id="theme-toggle-icon" class="theme-toggle-icon">‚òÄÔ∏è</button>
        </div>
    </header>

    <main>
        <h1 data-i18n="checkout">Checkout</h1>
        
        <div class="checkout-container">
            <section id="order-summary">
                <h2>Order Summary</h2>
                <div id="cart-items-list">
                    </div>
                <h3 id="order-total" data-i18n="total">Total: ‚Çπ0.00</h3>
            </section>

            <section id="delivery-details-form">
                <h2>Delivery Details</h2>
                <form id="checkout-form">
                    
                    <p class="input-label" data-i18n="name">Name</p>
                    <input type="text" id="delivery-name" placeholder="Name for Delivery" class="uniform-input" required>
                    
                    <p class="input-label" data-i18n="phone">Phone</p>
                    <div class="phone-input-group">
                        <span class="custom-country-code-fix">+91</span>
                        <input 
                            type="tel" 
                            id="delivery-phone" 
                            placeholder="Phone for Delivery" 
                            class="uniform-input phone-number-input" 
                            required 
                            maxlength="10" 
                            pattern="[0-9]{10}"
                            inputmode="numeric"
                        >
                    </div>

                    <p class="input-label" data-i18n="pincode">Pincode</p>
                    <input 
                        type="tel" 
                        id="pincode-input" 
                        placeholder="6-digit Pincode" 
                        class="uniform-input" 
                        required 
                        maxlength="6" 
                        pattern="[0-9]{6}"
                        inputmode="numeric"
                    >

                    <p class="input-label" data-i18n="address">Address</p>
                    <textarea id="delivery-address" placeholder="Full Delivery Address" class="uniform-input" required></textarea>
                    
                    <p id="checkout-message" style="color: red;"></p>

                    <button type="submit" id="checkout-button" data-i18n="checkout">Place Order</button>
                </form>
            </section>
        </div>
    </main>
    
    <nav class="bottom-nav">
        <div class="nav-links">
            <a href="home.html">
                <span class="nav-icon">üè†</span>
                <span data-i18n="catalog">Catalog</span>
            </a>
            <a href="cart.html">
                <span class="nav-icon">üõí</span>
                <span data-i18n="cart">Cart</span>
            </a>
            <a href="profile.html">
                <span class="nav-icon">üë§</span>
                <span data-i18n="profile">Profile</span>
            </a>
        </div>
    </nav>

    <footer>
        &copy; 2025 BooksByNIK. All rights reserved.
    </footer>

    <script type="module">
        import { getUserProfile, initializeThemeSwitch, initializeLanguageSelector, API_ENDPOINTS } from './script.js';

        const userProfile = getUserProfile();

        if (!userProfile) {
            window.location.href = 'index.html'; 
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeThemeSwitch();
            initializeLanguageSelector();
            
            // Pre-fill form fields with user profile data
            document.getElementById('delivery-name').value = userProfile.name || '';
            document.getElementById('delivery-phone').value = userProfile.phone || '';

            const checkoutForm = document.getElementById('checkout-form');
            checkoutForm.addEventListener('submit', handleCheckout);
        });

        async function handleCheckout(e) {
            e.preventDefault();
            
            const totalAmount = 1000; // Placeholder: Replace with actual cart total
            
            const orderData = {
                // User's registered phone (for backend linking)
                user_phone: userProfile.phone, 
                
                // Delivery details (editable by user)
                delivery_name: document.getElementById('delivery-name').value,
                delivery_phone: document.getElementById('delivery-phone').value,
                pincode: document.getElementById('pincode-input').value,
                address: document.getElementById('delivery-address').value,
                
                // Order content (Placeholder for actual cart items)
                items_json: JSON.stringify([{isbn: "123", qty: 1, price: 500}]), 
                total_amount: totalAmount,
            };

            const checkoutButton = document.getElementById('checkout-button');
            const messageElement = document.getElementById('checkout-message');

            checkoutButton.disabled = true;
            messageElement.textContent = "Submitting Order...";
            messageElement.style.color = 'blue';

            // NOTE: This will fail until you deploy your Orders API and update API_ENDPOINTS.ORDERS_API_ENDPOINT
            try {
                const response = await fetch(API_ENDPOINTS.ORDERS_API_ENDPOINT, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();

                if (result.success) {
                    messageElement.textContent = "Order Placed Successfully! Thank you.";
                    messageElement.style.color = 'green';
                    // Clear cart storage here (when cart logic is implemented)
                    // window.location.href = 'order_confirmation.html'; 
                } else {
                    messageElement.textContent = "Order submission failed: " + (result.error || "Server Error");
                    messageElement.style.color = 'red';
                }
            } catch (error) {
                messageElement.textContent = 'Could not connect to the Orders API.';
                messageElement.style.color = 'red';
            } finally {
                checkoutButton.disabled = false;
            }
        }
    </script>
</body>
</html>